<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shaolin Bolt Overlay</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div id="overlay" role="region" aria-label="Stream overlay">
        <div id="bgAnim" aria-hidden="true"></div>
        <img id="background" alt="Overlay background" />
        <img id="logo" alt="Channel logo" />
        <h1 id="mainTitle" aria-live="polite"></h1>
        <h2 id="subTitle" aria-live="polite"></h2>
    </div>

    <script>
    (function() {
        const defaults = {
            background: 'assets/storm-bg.png',
            logo: 'assets/bolt-logo.png',
            mainTitle: 'Starting Soon',
            subTitle: 'Welcome to the Bolt Dojo',
            mainColor: '#00AEEF',
            subColor: null,
            preset: 'starting'
        };

        function getQueryParam(name) {
            try {
                const url = new URL(window.location.href);
                return url.searchParams.get(name);
            } catch (e) {
                const match = window.location.search.match(new RegExp('[?&]' + name + '=([^&]+)'));
                return match && decodeURIComponent(match[1]);
            }
        }

        const configParam = getQueryParam('config');
        const presetParam = getQueryParam('preset');
        let configPath = 'config.json';
        if (configParam) configPath = configParam;
        else if (presetParam) configPath = presetParam.endsWith('.json') ? presetParam : `${presetParam}.json`;

        function applyConfig(config) {
            const cfg = Object.assign({}, defaults, config || {});
            document.body.classList.remove('starting','brb','ending','justchatting');
            const presetClass = (cfg.preset || cfg.mainTitle || '').toString().toLowerCase().replace(/\s+/g,'') || 'starting';
            document.body.classList.add(presetClass);

            const backgroundEl = document.getElementById('background');
            const logoEl = document.getElementById('logo');
            const mainTitleEl = document.getElementById('mainTitle');
            const subTitleEl = document.getElementById('subTitle');

            document.documentElement.style.setProperty('--main-color', cfg.mainColor || defaults.mainColor);
            document.documentElement.style.setProperty('--sub-color', cfg.subColor || cfg.mainColor || defaults.mainColor);

            if (cfg.background) {
                backgroundEl.src = cfg.background;
                backgroundEl.onload = () => { backgroundEl.style.display = 'block'; document.getElementById('bgAnim').classList.add('visible'); };
                backgroundEl.onerror = () => { backgroundEl.style.display = 'none'; document.getElementById('bgAnim').classList.remove('visible'); };
            } else {
                backgroundEl.style.display = 'none';
                document.getElementById('bgAnim').classList.remove('visible');
            }

            if (cfg.logo) {
                logoEl.src = cfg.logo;
                logoEl.onload = () => { logoEl.classList.add('loaded'); };
                logoEl.onerror = () => { logoEl.style.display = 'none'; logoEl.classList.remove('loaded'); };
            } else {
                logoEl.style.display = 'none';
                logoEl.classList.remove('loaded');
            }

            mainTitleEl.textContent = cfg.mainTitle || '';
            subTitleEl.textContent = cfg.subTitle || '';

            [mainTitleEl, subTitleEl].forEach(el => {
                el.classList.remove('animate');
                void el.offsetWidth;
                el.classList.add('animate');
            });
        }

        fetch(configPath)
            .then(response => {
                if (!response.ok) throw new Error('Failed to fetch config: ' + response.status);
                return response.json();
            })
            .then(cfg => applyConfig(cfg))
            .catch(err => {
                console.warn('Overlay: falling back to defaults; config load error:', err);
                applyConfig(defaults);
            });
    })();
    </script>
</body>
</html>
